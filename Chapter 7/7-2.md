## 程序中的命中测试
窗口消息处理程序经常必须在显示区域中进行一些命中测试。一般来说，命中测试中会使用xy坐标值，他们由鼠标消息的lParam参数给出。
### 一个假象的例子
这样一个例子。  
假设程序需要显示几列按字母排序的文件。我们必须要由自己来进行命中测试工作。  
假定文件名保存在称为szFileNames的已排序字符串指针数组中。  
假定文件列表开始于显示区域的顶端，显示区域cxClient像素宽，cyClient像素高，每列为cxColWidth像素宽，每个字符高度为cyChar像素高。
### 范例程序
参考 CHECKER1.C  
程序所示，将显示区域平均分为五乘五的方格，进行点击的时候判断在哪个方格并进行标记，然后在WM_PAINT中划交叉斜线。
### 使用键盘仿真鼠标
CHECKER1只能在装有鼠标的情况下才可以执行。下面我们在程序中加入键盘接口。  
即使没有安装鼠标，windows仍旧可以显示一个鼠标光标。windows为这个光标保存了一个“显示计数”。如果安装了鼠标则显示计数被初始化为0；没有安装则为-1，只有当显示计数为非负数时才显示鼠标光标。值得注意的是这是计数器，而不是单纯的布尔值，如果在程序中连续减去了多次，则需要加回来同样多的次数。以下有一些相关的函数：    
```c
ShowCursor(TURE);//增加计数器1  
ShowCursor(FALSE); //减少计数器1  
GetCursorPos(&ps);//获取当前鼠标的位置，这里没用到hwnd，显然是屏幕坐标  
SetCursorPos(x,y);//设定当前鼠标的位置，如果有需要的话可以使用ScreenToClient进行转换  
```
在处理鼠标消息时获得的鼠标位置和GetCursorPos获得的鼠标位置可能会有不同，**前者是产生消息时鼠标的位置，后者是鼠标当前位置。**  
我们接下来些的程序，当按下方向键时鼠标移动较慢，随后会加快。  
### 在CHECKER中加入键盘接口
参考 CHECKER2.C  
加入了通过方向键来控制鼠标光标的位置，以及通过回车和空格替代左键单击。
### 将子窗口用于命中测试
有些程序把显示区域分为几个小的逻辑区域。比如画图，有工具栏颜色栏菜单栏等等。实际上他把窗口划分成了不同的子窗口，拥有各自的串钩句柄和窗口消息处理程序以及显示区域。并且鼠标消息的lParam参数的坐标是对应于该子窗口显示区域左上角的坐标，而不是父窗口的。   
第九章中，我们将看到子窗口控件，滚动条、按钮和编辑方块等预先定义的子窗口。
### CHECKER中的子窗口
该版本建立了25个处理鼠标单机的子窗口，他没有键盘接口。  
参考CHECKER3.C  
CHECKER3有两个窗口消息处理程序WndProc和ChildWndProc。WndProc还是主窗口的窗口消息处理程序，ChildWndProc是针对25个子窗口的窗口消息处理程序。  
在注册子窗口的窗口类别前，有四个参数进行了调整：  
> pfnWndProc字段设定为ChildWndProc对应了子窗口的窗口消息处理程序  
> cbWndExtra字段设定为4字节，即sinzeof(long)。该字段告诉windows在其为此窗口类别的窗口保留的内部结构中，预留了4字节额外的控件，我们可以用来存储一些每个窗口不同的信息。  
> 由于这次使用的子窗口不需要图标，所以hIcon字段为null  
> pszClassName字段设定为Checker3_Child  
  
我们对主窗口和子窗口的窗口类别参数进行了一下比较：  
![](https://github.com/sii2017/image/blob/master/%E7%AA%97%E5%8F%A3%E7%B1%BB%E5%88%AB%E5%8F%82%E6%95%B0%E6%AF%94%E8%BE%83.jpg)  
主窗口没有父窗口句柄，所以为null。子窗口的父窗口句柄就是hwnd。  
现在我们的主窗口是没有菜单句柄的，所以为null。而对于子窗口来说，相同位置的参数称为子ID，这时唯一代表子窗口的数字很重要。但是在目前的程序中我们简单的设为了几个数值。  
主窗口的执行实体句柄可以很容易从winmain中获得，就是hinstance，但是在窗口消息处理函数中难以得到这个hInstance,所以需要用(HINSTANCE)GetWindowLong(hwnd, GWL_HINSTANCE)获得。当然也可以将hInstance保存下来直接使用。  
在CHECKER3中我们并没有做任何鼠标命中测试，我们需要知道的仅仅是CHECKER3中是否有子窗口被鼠标点击到了
### 子窗口和键盘
为CHECLER3添加键盘接口是该系列的最后一步。  
参考CHECKER4.C   
在CHECKER4中，整体变量idFocus用于保存目前输入焦点窗口的子窗口ID。因为当我们在子窗口上单机鼠标时，子窗口并不会自动获得输入焦点。总是由父窗口收到WM_SETFOCUS，然后再通过SetFocus(GetDlgItem(hwnd, idFocus))来将焦点转移到子窗口。