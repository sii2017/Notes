## 打印图形和文字
在一个Windows程序中，打印所需的额外负担通常比FORMFEED程序高得多，而且还要用GDI函数来实际打印一些东西。   
我们来写个打印一页文字和图形的程序，采用FORMFEED程序中的方法，并加入一些新的东西。**该程序将有三个版本PRINT1、PRINT2和PRINT3。**为避免程序代码重复，每个程序都用前面所示的GETPRNDC.C文件和PRINT.C文件中的函数。     
**参考PRINT.C**   
PRINT.C中包括函数WinMain、WndProc以及一个称为PageGDICalls的函数。   
PageGDICalls函数接收打印机设备内容句柄和两个包含打印页面宽度及高度的变量。该函数负责画一个包围整个页面的矩形，有两条对角线，页中间有一个椭圆（其直径是打印机高度和宽度中较小的那个的一半），文字「Hello, Printer!」位于椭圆的中间。  
> 值得注意的是，代码中有使用SaveDC和RestoreDC，在改变映射模式，以及边界大小前先保存原有的hdc，在一顿操作之后，再恢复原有的hdc。   
  
处理WM_CREATE消息时，WndProc将一个「Print」子菜单加到系统菜单上。选择该选项将调用PrintMyPage，此函数的功能在程序的三个版本中将不断增强。**当打印成功时，PrintMyPage传回TRUE值，如果遇到错误时则传回FALSE。**如果PrintMyPage传回FALSE，WndProc就会显示一个消息框以告知使用者发生了错误。    
以上程序PRINT.C还不能直接启动，需要配合之后的代码。
### 打印的基本程序
打印程序的第一个版本是PRINT1。   
经编译后即可执行此程序，然后从系统菜单中选择「Print」。接着，GDI将必要的打印机输出储存在一个临时文件中，然后打印队列程序将它发送给打印机。
参考PRINT1.C     
该程序中我们加入了打印的相关内容，获取打印机的设备内容，获取纸张的可打印范围，然后进行打印任务。   
> 仅当呼叫StartDoc、StartPage和EndPage都成功时，PRINT1才呼叫EndDoc打印函数。  
### 使用放弃程序来取消打印   
对于大型文件，程序应该提供使用者在应用程序打印期间取消打印任务的权利，并且是比较方便易操作的。   
在一个程序内取消一个打印任务需要一种称为“放弃程序”的技术。放弃程序在程序中只是一个较小的输出函数，**我们可以使用SetAbortProc函数将该函数的地址传给Windows**。然后GDI在打印时，重复呼叫该程序，不断地问：「我是否应该继续打印？」   
放弃程序一般命名为AbortProc:   
```c
BOOL CALLBACK AbortProc(HDC hdcPrn, int iCode)    
{    
	//其它程序     
}    
```    
打印前（调用StartDoc前）必须通过调用SetAbortProc来登记放弃程序。打印后不必清除。    
**在处理EndPage调用时（即在将metafile放入设备驱动程序并建立临时打印文件时），GDI通常在这里调用放弃程序。**     
如果一切正常，iCode参数为0；如果GDI模块在生成临时文件时耗尽了磁盘空间，iCode就是SP_OUTOFDISK。    
如果打印作业继续，那么AbortProc必须传回TRUE（非零）；如果打印作业异常结束，就传回FALSE（零）。放弃程序可以被简化为如下所示的形式：    
```c
BOOL CALLBACK AboutProc(HDC hdcPrn, int iCode)    
{    
	MSG msg;    
	while(PeekMessage(&msg, NULL, 0, 0, PM_REMOVE))    
	{    
		TranslageMessage(&msg);   
		DispatchMessage(&msg);    
	}
	return TRUE;     
}     
```
我们在第五章的RANDRECT程序中讨论过，PeekMessage会将控制权返回给程序，而不管程序的消息队列中是否有消息存在。而GetMessage在取得消息之前不会返回控制权。    
只要PeekMessage传回TRUE，那么AbortProc函数中的消息循环就重复呼叫PeekMessage。TRUE值表示PeekMessage已经找到一个消息，该消息可以通过TranslateMessage和DispatchMessage发送到程序的窗口消息处理程序。若程序的消息队列中没有消息，则PeekMessage的传回值为FALSE，因此AbortProc将控制权返回给Windows。（当然在打印的时候GDI会不断的调用该程序）
### Windows如何使用AbortProc

### 实作放弃程序
参考PRINT2.C
### 增加打印对话框
参考PRINT3.C
### 为POPPAD增加打印功能
参考POPPRNT.C