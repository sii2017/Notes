# 第三章 窗口和消息
在前两章，程序使用了MessageBox来输出文字。MessageBox就是一个窗口。  
本章将会建立自己的窗口，来设置自定义的标题列，选项图标，一行或多行文字等等。  
## 自己的窗口
建立窗口的基本函数为CreateWindows()。当然里面有各种需要设置的参数。将在下面详述。  
### 总体结构
进行windows程序设计，实际上是在进行一种对象导向的程序设计（OOP/Object Oriented Programming）。这是因为我们设计的/操作的对象具有人格化的特征，也就是这个叫做“窗口”的东西。  
作为对象，使用者会在屏幕上看到这些窗口，并且通过鼠标和键盘与他们进行交互操作。（更有趣的是，程序写作者的观点与使用者的观点极其类似）。  
窗口以“消息”的形式接收窗口的输入，窗口也用消息与其他窗口通讯。对消息的理解将是如何写作Windows程序必须掌握的难点之一。  
举例：  
当我们通过鼠标拖动窗口的边框来改变窗口的大小时，是windows本身调整了窗口的大小，而不是窗口本身调整自己的大小。当然由于窗口（应用程序）能改变自己显示的样子，所以它也“知道”窗口的大小改变了。  
那么窗口（应用程序本身）是如何知道窗口的大小改变了呢？通过widnows的机制，windows会发送一个消息指出新窗口的大小，然后程序就能根据收到的消息来响应相应的工作。  
“windows给程序发送消息”，是指windows呼叫程序中的一个函数，该函数的参数描述了这个特定消息。这种位于windows程序中的函数成为“窗口消息处理函数”。   
程序建立的每一个窗口都有窗口消息处理函数。   
1 该函数既可以在程序中也可以在**动态链接库**中。    
2 windows通过呼叫窗口消息处理函数来给窗口发送消息，窗口消息处理函数根据此消息来进行处理，然后将控制传回给windows。   
3 窗口通常是在“窗口类别”的基础上建立的。窗口类别表示了处理窗口消息的窗口消息处理程序。使用窗口类别使多个窗口能够属于同一个窗口类别，并使用同一个窗口消息处理函数。  
例如：所有windows程序中的所有按钮均依据同一个窗口类别。这个窗口类别与一个处理所有按钮消息的窗口消息处理程序联结（位于windows的动态链接库中）。   
Windows程序开始执行后，windows为该程序建立一个“消息队列”。这个“消息队列”用来存放该程序可能建立的各种不同窗口的消息。程序中有一小段代码，叫“消息循环”，用来从队列中取出消息，并且将他们（翻译）发送到相应的窗口处理程序。（有些消息直接发送给窗口消息处理程序，不用放入消息队列）。  
eg：  
```
whie(GetMessage(&msg, NULL, 0, 0)) //获取消息	  
{	
	TranslateMessage(&msg);//翻译消息	
	DispatchMessage(&msg);//派发消息		
}	
```		
参见程序3-1 HELLOWIN.C  
### windows函数调用
HELLOWIN中至少调用了18个windows函数，以下：  
LoadIcon 加载图标供程序使用  
LoadCursor 加载鼠标光标供程序使用  
GetStockObject 取得图形对象中的一种（此处为画刷）  
RigisterClass 为程序窗口注册窗口类别  
MessageBox 显示消息框  
CreateWindow 根据窗口类别建立一个窗口 
ShowWindow 再屏幕上显示窗口  
UpdateWindow 指示窗口自我更新  
GetMessage 从消息队列中取得信息  
TranslateMessage 翻译某些键盘消息  
DispatcMessage 将消息发送给窗口消息处理函数  
PlaySound 播放一个声音文件  
BeginPaint 开始绘制窗口  
GetClientRect 取得窗口显示区域的大小  
DrawText 显示字符串  
EndPaint 结束绘制窗口  
PostQuitMessage 在消息队列中插入一个“退出程序”的消息  
DefWindowProc 执行内定的消息处理  
这些函数均在Platform SDK文件中说明，并在不痛的头文件中声明，其中绝大多数声明在WINUSER.H中。  
### 大写字母标识符
在HELLOWIN.C中有几个大写的标识符，标识符用来设定不同的状态，且有其规律  
前缀为CS为窗口类别样式  
前缀为CW为建立窗口  
前缀为DT为绘制文字  
前缀为IDI为图示ID	  
前缀为IDC为游标ID  
前缀为MB为消息框   
前缀为SND为声音   
前缀为WM为窗口消息   
前缀为WS为窗口样式  
请不要费力去记忆以上图标。   
### 新的数据型态
常见但是不太明显的一些数据型态的说明：  
用于WndProc的第二个参数UINT只是一个unsighed int  
WndProc函数传回一个型态为LRESULT的值，实际上为LONG   
WinMain函数被指定了一个WINAPI型态（在头文件中定义的所有windows函数都被指定了这种形态），而WndProc函数被指定一个CALLBACK形态。这两个标识符都被定义为_stdcall，表示在windows本身和使用者的应用程序之间发生的函数调用的参数传递方式。  
在之前的HELLOWIN.C中实用了windows头文件中定义的四种数据结构  
MSG，消息结构  
WNDCLASS，窗口类别结构  
PAINTSTRUCT，绘图结构   
RECT，矩形结构   
### 句柄简介
有三个大写标识符，用于（代表）不同类型的“句柄”  
HINSTANCE，执行实体（程序自身）句柄  
HWND，窗口句柄（每个窗口都有自己的句柄）  
HDC，设备内容句柄（包括字体，画刷等等）  
句柄是一个整数，它代表一个对象。Windows中的句柄类似于C或者MS_DOS程序设计中使用的文件句柄。程序几乎总是通过调用windows函数取得句柄。程序在其他windows函数中使用这个句柄，代表使用这个对象。  
### 注册窗口类别
窗口（一般都）依照某一窗口类别建立，窗口类别用以标识处理窗口消息的窗口消息处理函数。  
不同窗口可以依照同一种窗口类别建立，并且使用同一个窗口消息处理函数。  
窗口类别定义了窗口的一些特征以及指定了窗口消息处理函数。  
在正式为程序建立窗口之前，必须先呼叫RegisterClass函数注册一个窗口类别。该函数只需要一个参数，即指向形态为WNDCLASS的结构指针。（也分为宽字符和一般字符两个版本）  
```typedef struct tagWNDCLASSA(tagWNDCLASSW)  
{  
	UINT style;//窗口样式  
	WNDPROC lpfnWndProc;//窗口消息处理函数  
	int cbClsExtra;//窗口类别结构中预留的空间  
	int cbWndExtra;//窗口结构中预留的空间  
	HINSTANCE hInstance;//程序的执行实体句柄（也是WinMain的参数之一）  
	HICON hIcon;//图标，出现在窗口的标题列的左端  
	HCURSOR hCursor;//鼠标光标  
	HBRUSH hbrBackground;//窗口背景颜色  
	LPCSTR(LPCWSTR) lpszMenuName;//应用程序菜单  
	LPCSTR(LPCWSTR) lpszClassName;//类别名称  
}```     
在WNDCLASS结构种最重要的两个字段是第二个和最后一个。第二个字段lpfnWndProc是依据这个类别来建立所有窗口所使用的窗口消息处理程序的地址。最后一个字段是窗口类别的文字名称。  
### 建立窗口  
窗口类别定义了窗口的一般特征，因此可以使用同一个窗口类别建立许多不同的窗口。而实际调用CreateWindow建立窗口时，可以指定有关窗口更详细的信息。  
下面时HELLOWIN.C中的CreateWindows调用，每一个字段都做了完整的说明：  
```hwnd= CreateWindow(szAppName,//使用的窗口类别名称  
TEXT("The Hello Program"),//窗口标题  
WS_OVERLAPPEDWINDOW,//窗口style  
CW_USEDEFAULT,//初始化x水平坐标  
CW_USEDEFAULT,//初始化y水平坐标  
CW_USEDEFAULT,//初始化x的宽度  
CW_USEDEFAULT,//初始化y的长度  
NULL,//父窗口句柄  
NULL,//窗口菜单句柄  
hInstance,//与窗口相关联的模块实例的句柄   
NULL,//creation parameters
```
在建立一个最上层窗口，则父窗口句柄的参数为NULL。如果窗口之间存在父子关系，则子窗口总时在父窗口的上面。应用程序窗口出现在桌面窗口的上面，但是不需要加入桌面窗口的句柄。  
CreateWindow传回被建立的窗口的句柄，并且存放在hwnd中。windows每一个窗口都有一个窗口句柄，程序使用句柄来使用窗口。很多windows函数需要hwnd作为参数，如此他们才知道函数时针对哪个窗口的。  
### 显示窗口  
### 消息循环  
  