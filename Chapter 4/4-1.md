# 第四章 输出文字
## 绘制和更新
在windows中，只能在窗口的显示区域绘制文字和图形，而且不能确保咋显示区域内显示的内容会一直保留到程序下一次“有意”改写他的时候。例如当我们拖拽两个窗口的时候，那么可能会覆盖一个窗口的一部分。在这种情况下windows并不会保存窗口中被覆盖的区域，当区域移开后，windows会要求我们的程序重新显示区域的这个部分（通过发送WM_PAINT消息）。  
windwos是一个消息驱动系统，他通过把消息投入消息队列来将发生的各种时间通知给应用程序。  
### WM_PAINT
当windows发送WM_PAINT消息通知窗口消息处理程序，则说明窗口的部分（全部）显示区域需要进行绘制。  
大多数windows程序在WinMain进入消息循环之前的初始化期间都要调用函数UpdateWindow，来发送第一次WM_PAINT消息，进行第一次“必须的绘制”显示区域。  
之后在发生以下几种事件之一时，窗口消息处理程序会收到一个WM_PAINT消息：  
移动或显示窗口时；改变窗口大小时；使用滚动条显示区域的一部分时；代码中使用InvalidateRect或InvalidateRgn函数刻意产生WM_PAINT消息时。另外包括当另外一个窗口遮蔽了这个窗口的一部分，亦或者下拉菜单挡住了窗口的部分这样的临时覆盖，windows有可能试图保存一个显示区域，但这**并不一定成功**，仍有刻意发送WM_PAINT消息。  
### 有效矩形和无效矩形  
尽管窗口消息处理程序一旦接收到WM_PAINT消息后，准备更新**整个**显示区域，但它经常只需要更新一个**较小**的区域，比较常见的是显示区域中的矩形区域。这个区域称为“无效区域/更新区域”。  
windows内部会为每个窗口保存一个“绘图信息结构”，这个结构包含了包围无效区域的最小矩形的坐标及其他信息，这个矩形就叫做“无效矩形/无效区域”。  
如果在消息处理程序处理WM_PAINT消息之前，显示区域的另一个区域也变为无效，windows并不会同时将多个WM_PAINT放到消息队列中，而是会重新计算出一个包围两个无效区域的新的无效区域，并且存放到“绘制信息结构”中。  
在处理WM_PAINT消息期间，当窗口消息处理程序呼叫了BeginPaint之后，整个区域就变为有效了。程序也可以呼叫ValidateRect函数使任意矩形变的有效。如果该函数使整个区域都变为有效，则目前队列中的所有WM_PAINT都将被删除。  
## GDI简介
要在窗口的显示区域绘图（文字），需要使用windows的图形设备接口（GDI）函数。  
目前最为普遍的的文字输出函数是TextOut,该函数的格式如下：  
`TextOut(hdc, x, y, psText, iLenght);`  
hdc参数是“设备内容句柄”，之前说过大部分用来绘图的GDI函数都需要hdc参数（可以理解为hdc是GDI函数的窗口通行证，有了句柄，程序写作者才能自如的使用GDI函数）。  
psText参数是指向字符串的指针，iLength是字符串的长度。xy定义了字符串在显示区域的开始位置。  
### 设备内容
设备内容（简称为“DC”，即HDC中的DC,H一般为句柄的意思），实际上是GDI内部保存的数据结构。它与特定的显示设备（如显示器或打印机）有关。  
设备内容中有些值是“图形属性”，定义了GDI函数工作的细节。如文字的颜色，背景色，xy坐标映像到窗口显示区域的方式（难点），windows显示文字使用的字体等等。  
当我们使用GDI函数的时候，都会先取得hdc句柄，并且会在函数中使用里面的属性来个性化的调用函数。  
当程序绘图完成以后，必须释放设备内容句柄，句柄在释放后就不再有效了。  
程序必须在单个消息内取得和释放句柄，因为除了调用CreateDC建立的设备内容之外，程序不能在2个消息间保存其他设备内容句柄。  
### windows取得设备内容句柄方法
方法一  
