# 第六章 键盘
在windows系统中，键盘和鼠标是两个标准的使用者输入来源。
## 键盘基础
键盘输入以“消息”的形式传递给程序的窗口消息处理程序。windows用八种不同的消息来传递不同的键盘事件，但是程序可以忽略其中至少一半的消息而不会有任何问题。因为他们并不是所有程序都必须需要的。处理键盘的部分工作就是识别出其中哪些是需要的，哪些是不需要的。
### 忽略键盘
尽管键盘是windows程序中使用者输入的主要来源，但是并不需要对所有键盘消息做出响应，并且windows本身也能处理许多键盘消息。  
### 获得焦点
由于键盘只有一个，所以它必须由windows下执行的所有应用程序共享，当应用程序有多个窗口，键盘也必须由该应用程序的多个窗口共享。  
当按下键盘上的按键，只有一个窗口消息处理程序接收该消息，并且此消息包括窗口控件码。  
接收特定键盘事件的窗口具有**输入焦点**。  
输入焦点的概念与活动窗口的概念相近。有输入焦点的窗口是活动窗口或活动窗口的衍生窗口（子窗口，或子窗口的子窗口等）。  
活动窗口通常很好辨认，它就是顶层窗口，父句柄为NULL。它的色彩将会突出，标题列将会突出等等。  
如果活动窗口有子窗口，那么输入焦点既可以在活动窗口也可以在子窗口。子窗口不能自己称为活动窗口。只有当它是活动窗口的衍生窗口时，子窗口才具有输入焦点，比如当子窗口空间显示出一个闪烁的输入符号或虚线的时候。  
窗口消息处理程序通过拦截WM_SETFOCUS和WM_KILLFOCUS消息来判定它的窗口何时拥有输入焦点。前者表示得到输入焦点，后者表示失去输入焦点。
### 队列和同步
当按下并释放键盘，windows和键盘驱动程序将硬件扫描码转换成格式消息。这些消息并不是直接保存到活动应用程序的”消息队列“中。  
实际上，消息先存放到windows的”系统消息队列“，当应用程序处理完前一个输入的消息时，windows从”系统消息队列“中取出下一个消息，将其放到应用程序”消息队列“中。
### 按键和字符
键盘消息可以分为按键和字符两种类型。  
对于能产生显示字符的按键或组合，windows发送字符消息和按键消息。对于不产生显示字符的按键或组合，windows仅仅发送按键消息。  
## 按键消息
当按下一个键时，windows发出WM_KEYDOWN或WM_SYSKEYDOWN消息，当释放一个键，windows发出WM_KEYUP或WM_SYSKEYUP消息。  
up和down总是成对出现的。当按住一个键使其自动重复的发送消息后，当按键松开，windows也会给消息处理程序发送一系列down消息。  
按键消息也有时间信息，可以通过GetMessageTime获得。  
### 系统按键和非系统按键
WM_SYS开头的代表系统按键消息，显然它对于windows比对于程序更加重要。通常程序忽略系统消息，并将他们传送给DefWindowProc来进行处理。   
尽量不要拦截这些消息，会导致windows无法正确的处理系统按键消息。拦截后如果仍希望windows进行处理需要将其发送给DefWindowProc。  
### 虚拟键码
虚拟键码保存在WM_KEYDOWN WM_KEYUP WM_SYSKEYDOWN WM_SYSKEYUP消息的wParam参数中。此代码标识按下或释放的键。  

### lParam信息
### 重复计数
### OEM扫描码
### 扩充键旗标
### 内容代码
### 键的先前状态
### 转换状态
### 位移状态
### 使用按键消息
### 为SYSMETS加上键盘处理功能
参考SYSMETS4.C