# 第十二章 剪贴簿
Microsoft Windows剪贴簿允许把数据从一个程序传送到另一个程序中。它的原理比较简单，并且对于程序而言并没有太大负担。   
Windows 98和Microsoft Windows NT都提供了剪贴簿浏览程序，该程序可以显示剪贴簿的目前内容。    
在我们之前写的程序中包含Edit菜单，其中有Cut，Copy和Paste选项。当我们使用Cut或者Copy时程序将数据传送给剪贴簿。这个数据使用某种格式，如文字、位图或者metafile（二进制元数值内容表示的绘图命令集）等。当我们使用Paste时，程序会检查剪贴簿中包含的数据，看看使用的是否是本程序可以接受的一种格式。如果可以，那么数据将从剪贴簿中传送到程序中。  
在之前的程序中，我们在Edit中只是发消息给编辑控件，并没有真正实现剪贴簿的功能。本章集中讨论将文字传入和移出剪贴簿。在后面的章节里，我将向您展示如何用剪贴簿处理位图（第十四、十五和十六章）和metafile（第十八章）。  
## 剪贴簿的简单使用
我们由**分析把数据传送到剪贴簿（剪下或复制）**和**存取剪贴簿数据（粘贴）**的程序代码开始。   
### 标准剪贴簿数据格式
Windows支持不同的预先定义剪贴簿格式，这些格式在WINUSER.H定义成以CF为前缀的标识符。   
**首先介绍三种能够储存在剪贴簿上的文字数据型态，以及一个与剪贴簿格式相关的数据型态**：      
**CF_TEXT**以NULL结尾的ANSI字符集字符串。它在每行末尾包含一个carriage return和linefeed字符，这是最简单的剪贴簿数据格式。传送到剪贴簿的数据存放在整体内存块中，并且是利用内存块句柄进行传送的（我将简短地讨论此项概念）。这个内存块专供剪贴簿使用，建立它的程序不应该继续使用它。    
**CF_OEMTEXT**含有文字数据（与CF_TEXT类似）的内存块。但是它使用的是OEM字符集。**通常Windows程序不必关心这一点；它只有与在窗口中执行MS-DOS程序一起使用剪贴簿时才会使用**。     
**CF_UNICODETEXT**含有Unicode文字的内存块。与CF_TEXT类似，它在每一行的末尾包含一个carriage return和linefeed字符，以及一个NULL字符（两个0字节）以表示数据结束。**CF_UNICODETEXT只支援Windows NT**。    
**CF_LOCALE**一个国家地区标识符的句柄。表示剪贴簿文字使用的国别地区设定。     
**下面是两种附加的剪贴簿格式，它们在概念上与CF_TEXT格式相似（也就是说，它们都是文字数据），但是它们不需要以NULL结尾，因为格式已经定义了数据的结尾。现在已经很少使用这些格式了**：    
**CF_SYLK**包含Microsoft「符号连结」数据格式的整体内存块。这种格式用在Microsoft的Multiplan、Chart和Excel程序之间交换数据，它是一种ASCII码格式，每一行都用carriage return和linefeed结尾。   
**CF_DIF**包含数据交换格式(DIF)之数据的整体内存块。这种格式是由Software Arts公司提出的，用于把数据送到VisiCalc电子表格程序中。这也是一种ASCII码格式，每一行都使用carriage return和linefeed结尾。   
**下面三种剪贴簿格式与位图有关。所谓位图就是数据位的矩形数组，其中的数据位与输出设备的图素相对应。 第十四和第十五章将详细讨论位图以及这些位图剪贴簿的格式**：    
**CF_BITMAP**与设备相关的位图格式。位图是通过位图句柄传送给剪贴簿的。同样，在把这个位图传送给剪贴簿之后，程序不应该再继续使用这个位图。
**CF_DIB**定义一个设备无关位图（在第十五章中描述）的内存块。这种内存块是以位图信息结构开始的，后面跟着可用的颜色表和位图数据位。   
**CF_PALETTE**调色盘句柄。它通常与CF_DIB配合使用，以定义与设备相关的位图所使用的颜色调色盘。   
**在剪贴簿中，还有可能以工业标准的TIFF格式储存的位图数据**：   
**CF_TIFF**含有标号图像文件格式(TIFF)数据的整体内存块。这种格式由Microsoft、Aldus公司和Hewlett-Packard公司以及一些硬件厂商推荐使用。这一格式可从Hewlett-Packard的网站上获得。    
**下面是两个metafile格式，我将在第十八章详细讨论。一个metafile就是一个以二进制格式储存的画图命令集**：     
**CF_METAFILEPICT**以旧的metafile格式存放的「图片」。   
**CF_ENHMETAFILE**增强型metafile（32位Windows支持的）句柄。   
****最后介绍几个混合型的剪贴簿格式**：   
CF_PENDATA**与Windows的笔式输入扩充功能联合使用。   
**CF_WAVE**声音（波形）文件。   
**CF_RIFF**使用资源交换文件格式（Resource Interchange File Format）的多媒体数据。   
**CF_HDROP**与拖放服务相关的文件列表。   
### 内存配置
程序向剪贴簿传输一些数据的时候，必须配置一个内存块，并且将这块内存交给剪贴簿处理。  
在之前我们使用标准c的malloc函数来分配内存，但是由于windows执行的应用程序之间必须要共享剪贴簿所存储的内存块，这时malloc函数就不能使用了。   
现在我们需要把windows早期的内存配置函数拿出来使用，现在的windows仍然支持他们，只是并不必须使用。    
要用windows API来配置一个内存块，可以调用：   
```c
hGlobal= GlobalAlloc(uiFlags, dwSize);   
```    
其中第一个参数是可能的旗标，第二个参数是内存块的字节大小。函数传回一个HGLOBAL型态的句柄，称为「整体内存块句柄」或「整体句柄」。传回值为NULL表示不能配置足够的内存。   
如果将第一个参数设定为0，那么您就可以更有效地使用旗标GMEM_FIXED（固定内存块）。在这种情况下，GlobalAlloc传回的整体句柄实际是指向所配置内存块的指针。
### 将文字传送到剪贴簿
### 从剪贴簿取得文字
### 打开和关闭剪贴簿
### 剪贴簿和Unicode
参考CLIPTEXT.C